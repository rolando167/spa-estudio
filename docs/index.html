<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPA Estudios</title>
    <link rel="manifest" href="manifest.json" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        .card.dark-mode {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
    </style>
</head>

<body class="dark-mode">

    <!-- Pantalla de login simple -->
    <div id="loginScreen" style="
                position: fixed;
                inset: 0;
                background: #000c;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            ">
        <div class="card p-4 text-center bg-dark bg-gradient" style="max-width: 300px; width: 100%;">
            <h4 class="mb-3 text-light">Acceso ðŸ”’</h4>
            <input type="password" id="inputPass" class="form-control mb-3" placeholder="ContraseÃ±a">
            <button id="btnLogin" class="btn btn-primary w-100">Entrar</button>
            <small id="loginError" class="text-danger mt-2 d-none">ContraseÃ±a incorrecta</small>
        </div>
    </div>

    <div id="appContent" class="container my-4" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="text-primary">Mis Estudios ðŸ“•</h1>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="toggleDark">
                <label class="form-check-label" for="toggleDark">Modo Claro</label>
            </div>

            <button onclick="logout()" class="btn btn-outline-danger btn-sm  ">Salir</button>

        </div>

        <div class="row mb-3">
            <!-- Selector de categorÃ­a -->
            <div class="col-md-6 col-sm-6">
                <select class="form-select form-select-sm border border-primary bg-secondary bg-gradient"
                    id="selectCategoria">
                    <option value="">-- Seleccionar --</option>
                </select>
            </div>

            <!-- Selector de curso -->
            <div class="col-md-6  col-sm-6">
                <select class="form-select form-select-sm border border-danger bg-secondary bg-gradient"
                    id="selectCurso" disabled>
                    <option value="">-- Seleccionar --</option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <span>Fecha y Hora Datos:</span> <span id="fechHoraDatos" class="text-primary"></span>
            </div>
        </div>

        <!-- Contenedor de preguntas -->
        <div id="preguntasContainer"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Tu archivo data-estudios-2.js -->
    <script src="data-estudios-2.js"></script>

    <!-- js-sha256 -->
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>

    <script>
        const selectCategoria = document.getElementById('selectCategoria');
        const selectCurso = document.getElementById('selectCurso');
        const preguntasContainer = document.getElementById('preguntasContainer');
        const toggleDark = document.getElementById('toggleDark');
        const body = document.body;
        const fechHoraDatos = document.getElementById('fechHoraDatos');

        const PASSWORD_HASH = "b2b2f104d32c638903e151a9b20d6e27b41d8c0c84cf8458738f83ca2f1dd744";
        const STORAGE_KEY = "spa_acceso_permitido";

        const loginScreen = document.getElementById("loginScreen");
        const appContent = document.getElementById("appContent");
        const btnLogin = document.getElementById("btnLogin");
        const inputPass = document.getElementById("inputPass");
        const loginError = document.getElementById("loginError");

        // ðŸ”¥ Si ya iniciÃ³ sesiÃ³n antes â†’ saltar login
        if (localStorage.getItem(STORAGE_KEY) === "1") {
            loginScreen.remove();
            appContent.style.display = "block";
        }

        // Intentar login
        btnLogin.addEventListener("click", () => { //async

            // const typedHash = await sha256(inputPass.value.trim());// 99%, pero no en live server
            const typedHash = sha256(inputPass.value.trim());

            if (typedHash === PASSWORD_HASH) {
                // Guardar que ya iniciÃ³ sesiÃ³n
                localStorage.setItem(STORAGE_KEY, "1");

                // Ocultar login
                loginScreen.style.display = "none";
                // Mostrar app
                appContent.style.display = "block";
            } else {
                loginError.classList.remove("d-none");
            }
        });

        // Permitir Enter
        inputPass.addEventListener("keypress", (e) => {
            if (e.key === "Enter") btnLogin.click();
        });

        // Alternar modo oscuro/claro
        toggleDark.addEventListener('change', () => {
            body.classList.toggle('dark-mode', !toggleDark.checked);
            document.querySelectorAll('.card').forEach(c => c.classList.toggle('dark-mode', !toggleDark.checked));
        });

        // Funcion sha256
        // async function sha256(text) {
        //     const encoder = new TextEncoder();
        //     const data = encoder.encode(text);
        //     const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        //     const hashArray = Array.from(new Uint8Array(hashBuffer));
        //     return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
        // }

        // Cargar categorÃ­as en el select
        function cargarCategorias() {
            datos.estudios.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nombre;
                selectCategoria.appendChild(option);
            });
            fechHoraDatos.textContent = `${datos.fecha} ${datos.hora}`;
        }

        // Cargar examenes segÃºn categorÃ­a seleccionada
        selectCategoria.addEventListener('change', () => {
            preguntasContainer.innerHTML = '';
            selectCurso.innerHTML = '<option value="">-- Seleccionar --</option>';
            selectCurso.disabled = !selectCategoria.value;
            if (!selectCategoria.value) return;

            const categoria = datos.estudios.find(c => c.id === selectCategoria.value);
            categoria.examenes.forEach(curso => {
                const option = document.createElement('option');
                option.value = curso.id;
                option.textContent = curso.nombre;
                selectCurso.appendChild(option);
            });
        });

        // Cargar preguntas segÃºn curso seleccionado
        selectCurso.addEventListener('change', () => {
            preguntasContainer.innerHTML = '';
            if (!selectCurso.value) return;

            const categoria = datos.estudios.find(c => c.id === selectCategoria.value);
            const examen = categoria.examenes.find(c => c.id === selectCurso.value);

            examen.preguntas.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'card mb-2' + (body.classList.contains('dark-mode') ? ' dark-mode' : '');
                card.innerHTML = `
                <div class="card-header">
                    <button class="btn btn-link text-decoration-none w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                   ${index + 1}. ${p.pregunta}
                    </button>
                </div>
                <div id="collapse${index}" class="collapse">
                    <div class="card-body" style="text-align: justify;">&#10148; ${p.respuesta}</div>
                </div>
            `;
                preguntasContainer.appendChild(card);
            });
        });

        cargarCategorias();

        function logout() {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        function mostrarNotificacion(titulo, cuerpo) {
            if (Notification.permission === "granted") {
                new Notification(titulo, {
                    body: cuerpo,
                    icon: "icon-192.png"
                });
            }
        }

        // Ejemplo: recordatorio cada 1 hora
        // setInterval(() => {
        //     mostrarNotificacion("Estudios SPA", "Â¡Hora de repasar tus preguntas!");
        // }, 60000); // 3600000 ms = 1 hora

        /** -----------  Permisos General ------------ */

        // if ("serviceWorker" in navigator) {
        //     navigator.serviceWorker.register("sw.js")
        //         .then(() => console.log("Service Worker registrado"));
        // }

        // if ("Notification" in window) {
        //     Notification.requestPermission().then(permission => {
        //         if (permission === "granted") {
        //             console.log("Notificaciones permitidas");
        //         }
        //     });
        // }

    </script>

</body>

</html>